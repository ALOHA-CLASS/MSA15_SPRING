<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fetch API</title>
</head>
<body>
  <h1>Fetch API</h1>

  <h5>게시글 조회</h5>
  <label for="no">게시글 번호</label>
  <input type="text" name="no" id="no">
  <button onclick="getBoard()">조회</button>
  <hr>
  <div>
    <h5>조회된 게시글 정보</h5>
    <h3><span>제목 : </span><span id="title"></span></h3>
    <h3><span>작성자 : </span><span id="writer"></span></h3>
    <textarea id="content" cols="50" rows="10" readonly></textarea>
  </div>

  <hr>
  <h3>게시글 등록/수정/삭제</h3>
  <form action="/api/boards" method="post">
    <table>
      <tr>
        <td><label for="title">제목</label></td>
        <td><input type="text" name="title" id="input-title"></td>
      </tr>
      <tr>
        <td><label for="writer">작성자</label></td>
        <td><input type="text" name="writer" id="input-writer"></td>
      </tr>
      <tr>
        <td><label for="content">내용</label></td>
        <td>
          <textarea name="content" id="input-content" cols="50" rows="10"></textarea>
        </td>
      </tr>
      <tr>
        <td><label for="updateNo">글번호</label></td>
        <td><input type="text" name="no" id="input-no" placeholder="수정/삭제 번호"></td>
      </tr>
    </table>
    <button type="button" onclick="insert()">등록하기</button>
    <button type="button" onclick="update()">수정하기</button>
    <button type="button" onclick="remove()">삭제하기</button>
  </form>
  <hr>

  <h3>게시글 목록</h3>
  <table id="board-list" border="1">
    <tr id="board-title">
      <th width="50">번호</th>
      <th width="300">제목</th>
      <th width="100">작성자</th>
      <th width="200">등록일자</th>
      <th width="200">수정일자</th>
    </tr>
    <tbody id="board-body">
      <tr id="board-data">
        <td colspan="5" align="center">조회된 데이터가 없습니다.</td>
      </tr>
    </tbody>
  </table>

  <div style="height: 1000px;"></div>

  <script>
    // 게시글 조회
    async function getBoard() {
      // 입력한 글 번호 가져오기
      let no = document.getElementById("no").value

      // 요청 설정
      let url = `http://127.0.0.1:8080/api/boards/${no}`
      
      try {
        // Fetch API로 GET 요청
        const response = await fetch(url)

        // 응답 성공 확인
        if (response.ok) {
          // JSON으로 파싱
          const board = await response.json()

          if (!board) {
            alert('응답된 데이터가 없습니다.')
          } else {
            let title = document.getElementById("title")
            let writer = document.getElementById("writer")
            let content = document.getElementById("content")

            title.textContent = board.title
            writer.textContent = board.writer
            content.textContent = board.content
          }
        } else {
          alert('데이터 조회에 실패했습니다.')
        }
      } catch (error) {
        console.error('Error:', error)
        alert('요청 중 오류가 발생했습니다.')
      }
    }

    // 게시글 목록 조회    
    async function getList() {
      // 요청 설정
      let url = `http://127.0.0.1:8080/api/boards`
      
      try {
        // Fetch API로 GET 요청
        const response = await fetch(url)

        // 응답 성공 확인
        if (response.ok) {
          // JSON으로 파싱
          const boardList = await response.json()

          // 데이터 없을 때
          if (boardList.length == 0) {
            alert('응답된 데이터가 없습니다.')
          }
          // 데이터 있을 때
          else {
            let $boardData = document.getElementById('board-data')
            let $boardList = document.getElementById('board-list')
            let $boardBody = document.getElementById('board-body')

            // 데이터 초기화
            $boardBody.innerHTML = ''

            let tr = ''
            for (const board of boardList) {
              tr += `<tr>
                        <td>${board.no}</td>
                        <td>${board.title}</td>
                        <td>${board.writer}</td>
                        <td>${board.createdAt}</td>
                        <td>${board.updatedAt}</td>
                      </tr>`
            }
            
            $boardBody.innerHTML = tr
          }
        }
      } catch (error) {
        console.error('Error:', error)
        alert('목록 조회 중 오류가 발생했습니다.')
      }
    }
    // 게시글 목록 함수 호출
    getList()

    // 게시글 등록
    async function insert() {
      // 입력 정보
      let title = document.getElementById("input-title").value
      let writer = document.getElementById("input-writer").value
      let content = document.getElementById("input-content").value

      // 객체
      let data = {
        'title': title,
        'writer': writer,
        'content': content,
      }

      // 요청 설정
      let url = `http://127.0.0.1:8080/api/boards`
      
      try {
        // Fetch API로 POST 요청
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })

        const result = await response.text()

        if (response.status == 201) {
          alert(result)
          // 등록 후 목록 갱신
          getList()
        } else if (response.status == 400) {
          alert("클라이언트의 잘못된 요청")
        } else if (response.status == 500) {
          alert("서버 내부 에러")
        }
      } catch (error) {
        console.error('Error:', error)
        alert('등록 중 오류가 발생했습니다.')
      }
    }

    // 게시글 수정
    async function update() {
      // 입력 정보
      let no = document.getElementById("input-no").value
      let title = document.getElementById("input-title").value
      let writer = document.getElementById("input-writer").value
      let content = document.getElementById("input-content").value

      // 객체
      let data = {
        'no': no,
        'title': title,
        'writer': writer,
        'content': content
      }

      // 요청 설정
      let url = 'http://127.0.0.1:8080/api/boards'
      
      try {
        // Fetch API로 PUT 요청
        const response = await fetch(url, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })

        const result = await response.text()

        // 요청 성공
        if (response.status == 200) {
          alert(result)
          getList()
        }
        // 요청 실패
        else if (response.status == 400) {
          alert("클라이언트의 잘못된 요청")
        } else if (response.status == 500) {
          alert("서버 내부 에러")
        }
      } catch (error) {
        console.error('Error:', error)
        alert('수정 중 오류가 발생했습니다.')
      }
    }


    // 게시글 삭제
    async function remove() {
      // 입력 정보
      let no = document.getElementById('input-no').value

      // ✅ DELETE 요청 방식은 요청 데이터를 URL 에 포함하여 전송한다.
      // 요청 설정
      let url = `http://127.0.0.1:8080/api/boards/${no}`
      
      try {
        // Fetch API로 DELETE 요청
        const response = await fetch(url, {
          method: 'DELETE'
        })

        const result = await response.text()

        // 요청 성공
        if (response.status == 200) {
          alert(result)
          getList()
        } else if (response.status == 400) {
          alert('클라이언트의 잘못된 요청')
        } else if (response.status == 500) {
          alert('서버 내부 에러')
        }
      } catch (error) {
        console.error('Error:', error)
        alert('삭제 중 오류가 발생했습니다.')
      }
    }
  </script>
</body>
</html>